

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tikal.toy_controller &mdash; TIKAL 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            TIKAL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">tikal</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TIKAL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tikal.toy_controller</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tikal.toy_controller</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">ROTATION_TOY_NAMES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.toy_bled</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToyBLED</span><span class="p">,</span> <span class="n">LovenseBLED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.toy_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOVENSE_TOY_NAMES</span>


<div class="viewcode-block" id="ToyController">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ToyController</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toy</span><span class="p">:</span> <span class="n">ToyBLED</span><span class="p">,</span> <span class="n">toy_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extends the low-level ToyBLED class, providing convenient synchronized methods (instead of async) and</span>
<span class="sd">        pattern-related functionalities. You are not meant to instantiate this class yourself. The ToyHub will produce</span>
<span class="sd">        and return instances of this class for you.</span>

<span class="sd">        Args:</span>
<span class="sd">            toy: Toy object representing the physical lovense toy.</span>
<span class="sd">            toy_id: Unique ID of the toy.</span>
<span class="sd">            logger_name: Name of the logger to use. Empty string for root logger.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span> <span class="o">=</span> <span class="n">toy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toy_id</span> <span class="o">=</span> <span class="n">toy_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span> <span class="o">=</span> <span class="n">toy</span><span class="o">.</span><span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>

        <span class="c1"># Command queue: stores tuples of (coroutine, callback)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command_queue</span><span class="p">:</span> <span class="n">deque</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">deque</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Pattern state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_wraparound</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Playback state - now duration-based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_elapsed_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Time elapsed in the pattern (excluding pauses)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Real time when the current segment started</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause_segment_elapsed</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Time elapsed in the segment before a pause</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;intensity1&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;intensity2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accepted_pause</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ToyController initialized for </span><span class="si">{</span><span class="n">toy_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the toy is currently paused, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_blocked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the toy is currently blocked, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">toy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the unique ID of the toy. If the toy is connected via bluetooth: toy_id == bluetooth address.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the model name of the toy&#39;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the toy is currently connected False otherwise. If False commands aren&#39;t set to the toy.</span>
<span class="sd">        Commands aren&#39;t lost. Upon re-establishment of the connection, they are sent to the toy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span>

    <span class="nd">@connected</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called by the ToyHub when the connection is lost/restored. You are not supposed to call this!&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the names of intensity1 and intensity2 for this toy type.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity_max_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the maximum intensity value for this toy type.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="ToyController.change_rotate_direction_available">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.change_rotate_direction_available">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_rotate_direction_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns true if the toy supports changing the rotation direction, false otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span> <span class="ow">in</span> <span class="n">ROTATION_TOY_NAMES</span></div>


<div class="viewcode-block" id="ToyController.toggle_pause">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.toggle_pause">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Toggle pause state. Returns true if paused, False if unpaused. If paused and a pattern is set, the pattern</span>
<span class="sd">        progresses, but toy intensities are forced to remain 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if paused, False if unpaused</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ToyController toggle pause: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">toy_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_paused</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># I don&#39;t want to pause and block at the same time</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_paused</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ToyController.toggle_block">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.toggle_block">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_block</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Toggle block state. Returns true if blocked, False if unblocked. If a pattern is set</span>
<span class="sd">        If blocked, the toys intensities are forced to remain 0 (even when manual commands are used)</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if blocked, False if unblocked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ToyController toggle block: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">toy_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_paused</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># I don&#39;t want to pause and block at the same time&#39;</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ToyController.set_pattern">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.set_pattern">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_pattern</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pattern</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
            <span class="n">wraparound</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">reset_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets a new pattern.</span>
<span class="sd">        Patterns are defined as a list of tuples (duration_ms, intensity1, intensity2). Each tuple represents a segment</span>
<span class="sd">        with a duration in milliseconds.</span>
<span class="sd">        Example: [(100, 5, 5), (200, 0, 0)] sets intensity1=intensity2=5 for 100ms, then intensity1=intensity2=0 for 200ms.</span>
<span class="sd">        An empty list means that no pattern is set and allows the toy to be controlled manually.</span>

<span class="sd">        Args:</span>
<span class="sd">            pattern: Pattern to be set</span>
<span class="sd">            wraparound: Whether the pattern should wrap around and be repeated indefinitely</span>
<span class="sd">            reset_time: Whether to reset the pattern playback position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ToyController sets pattern for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">toy_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span> <span class="o">=</span> <span class="n">pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_wraparound</span> <span class="o">=</span> <span class="n">wraparound</span>
        <span class="k">if</span> <span class="n">reset_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restart_pattern</span><span class="p">()</span>
        <span class="c1"># If not resetting, keep the current elapsed time to maintain position</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="p">:</span>  <span class="c1"># ensure that intensities are at 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<div class="viewcode-block" id="ToyController.get_pattern_time">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.get_pattern_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pattern_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get time elapsed in the current pattern (excluding pauses). Returns 0.0 if no pattern is set</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Time elapsed since pattern start or last wraparound (in ms)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span><span class="p">:</span>
            <span class="c1"># When paused, return the frozen elapsed time</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_elapsed_time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Calculate time elapsed in current segment</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">segment_elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span>

        <span class="c1"># Total elapsed = pattern elapsed at segment start + current segment elapsed</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_elapsed_time</span> <span class="o">+</span> <span class="n">segment_elapsed</span></div>


<div class="viewcode-block" id="ToyController.get_pattern_values">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.get_pattern_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pattern_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get pattern values at the specific time.</span>

<span class="sd">        Args:</span>
<span class="sd">            pattern_time: Time (in ms) elapsed in the pattern.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[int, int]: (intensity1, intensity2) values at the specified time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># Calculate total pattern duration</span>
        <span class="n">total_duration</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">duration</span> <span class="k">for</span> <span class="n">duration</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_duration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># Handle wraparound</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_wraparound</span><span class="p">:</span>
            <span class="n">pattern_time</span> <span class="o">=</span> <span class="n">pattern_time</span> <span class="o">%</span> <span class="n">total_duration</span>
        <span class="k">elif</span> <span class="n">pattern_time</span> <span class="o">&gt;=</span> <span class="n">total_duration</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># Find the segment we&#39;re in</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">duration</span><span class="p">,</span> <span class="n">intensity1</span><span class="p">,</span> <span class="n">intensity2</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern_time</span> <span class="o">&lt;</span> <span class="n">elapsed</span> <span class="o">+</span> <span class="n">duration</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">intensity1</span><span class="p">,</span> <span class="n">intensity2</span>
            <span class="n">elapsed</span> <span class="o">+=</span> <span class="n">duration</span>

        <span class="c1"># Should not reach here, but return last segment values</span>
        <span class="k">return</span> <span class="n">pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span></div>


<div class="viewcode-block" id="ToyController.intensity1">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.intensity1">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity1</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the intensity of the toy&#39;s primary capability to the specified level.</span>
<span class="sd">        Values outside the valid range (0-20) are clamped. Does not work if the toy is currently blocked.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            level: level to set the toy&#39;s primary intensity to.</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ToyController.intensity2">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.intensity2">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity2</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the intensity of the toy&#39;s secondary capability to the specified level.</span>
<span class="sd">        Does not work if the toy is currently blocked.</span>
<span class="sd">        Always succeeds (but does nothing) if the toy has no secondary intensity.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            level: level to set the toy&#39;s secondary intensity to.</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ToyController.change_rotate_direction">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.change_rotate_direction">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_rotate_direction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the rotation direction of the toy (if available, else does nothing and returns True)</span>
<span class="sd">        See self.change_rotate_direction_available() to find out if the toy supports this.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ToyController.stop">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.stop">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops all toy actions (set all intensities to zero).</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ToyController.get_battery_level">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.get_battery_level">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_battery_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the battery level of the toy.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Callback called with the battery level (or None if unavailable)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ToyController.get_information">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.get_information">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gathers information about the toy. Needs to send several commands to the Toy to find out the information.</span>
<span class="sd">        Does not send commands directly but schedules them to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Callback called with a dictionary containing information about the toy.</span>
<span class="sd">                Contains the keys: &#39;Battery Level&#39;, &#39;Status&#39;, &#39;Batch number&#39;, &#39;Bluetooth name&#39;, and &#39;Device type&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ToyController.direct_command">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.direct_command">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">direct_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the specified command to the toy.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            command: String containing the command to send.</span>
<span class="sd">            callback: Callback called with the response from the toy (always a string).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="c1"># ------------------------------------------------------------------------------------------------------------------</span>
    <span class="c1"># Private Methods</span>
    <span class="c1"># ------------------------------------------------------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">toy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the underlying low-level toy object. Called by the ToyHub if needed.</span>
<span class="sd">        You are not supposed to call this!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span>

    <span class="nd">@toy</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">toy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toy</span><span class="p">:</span> <span class="n">ToyBLED</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the underlying low-level toy object. Called by the ToyHub if needed.</span>
<span class="sd">        You are not supposed to call this!</span>

<span class="sd">        Args:</span>
<span class="sd">            toy (ToyBLED): New toy object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span> <span class="o">=</span> <span class="n">toy</span>

<div class="viewcode-block" id="ToyController.process_communication">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.ToyController.process_communication">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically called by the ToyHub for pattern control and command execution.</span>
<span class="sd">        You are not supposed to call this!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Process queued commands first</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_command_queue</span><span class="p">()</span>

        <span class="c1"># Then handle pattern playback</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Handle a paused or blocked state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepted_pause</span><span class="p">:</span>
                <span class="c1"># First time entering paused/blocked state - send stop command</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_values</span><span class="p">[</span><span class="s2">&quot;intensity1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_values</span><span class="p">[</span><span class="s2">&quot;intensity2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_accepted_pause</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># If already paused/blocked, do nothing (no repeated stop commands)</span>

        <span class="c1"># Handle active state</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accepted_pause</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Get current values and send commands if values have changed</span>
            <span class="n">pattern_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pattern_time</span><span class="p">()</span>
            <span class="n">intensity1_value</span><span class="p">,</span> <span class="n">intensity2_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pattern_values</span><span class="p">(</span><span class="n">pattern_time</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">intensity1_value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_values</span><span class="p">[</span><span class="s2">&quot;intensity1&quot;</span><span class="p">]:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">intensity1</span><span class="p">(</span><span class="n">intensity1_value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_values</span><span class="p">[</span><span class="s2">&quot;intensity1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity1_value</span>

            <span class="k">if</span> <span class="n">intensity2_value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_values</span><span class="p">[</span><span class="s2">&quot;intensity2&quot;</span><span class="p">]:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">intensity2</span><span class="p">(</span><span class="n">intensity2_value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_values</span><span class="p">[</span><span class="s2">&quot;intensity2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity2_value</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_command_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process all queued commands.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_queue</span><span class="p">:</span>
            <span class="n">command</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">command</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error executing command </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> with details </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_schedule_command</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a command to the execution queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">command</span><span class="p">,</span> <span class="n">callback</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_restart_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restart pattern timing from the beginning.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_elapsed_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause_segment_elapsed</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_paused</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paused</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets whether the toy is currently paused. Patterns of paused toys do not advance.</span>

<span class="sd">        Args:</span>
<span class="sd">            paused: Whether the toy is currently paused.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">paused</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span> <span class="o">=</span> <span class="n">paused</span>
        <span class="k">if</span> <span class="n">paused</span><span class="p">:</span>
            <span class="c1"># Entering pause: update elapsed time up to now</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">segment_elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pattern_elapsed_time</span> <span class="o">+=</span> <span class="n">segment_elapsed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pause_segment_elapsed</span> <span class="o">=</span> <span class="n">segment_elapsed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Exiting pause: reset segment start time now</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_segment_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span></div>



<div class="viewcode-block" id="LovenseController">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LovenseController</span><span class="p">(</span><span class="n">ToyController</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toy</span><span class="p">:</span> <span class="n">LovenseBLED</span><span class="p">,</span> <span class="n">toy_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logger_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extends the low-level LovenseBLED class, providing convenient synchronized methods (instead of async) and</span>
<span class="sd">        pattern-related functionalities. You are not meant to instantiate this class yourself. The ToyHub will produce</span>
<span class="sd">        and return instances of this class for you.</span>

<span class="sd">        Args:</span>
<span class="sd">            toy: Toy object representing the physical lovense toy.</span>
<span class="sd">            toy_id: Unique ID of the toy.</span>
<span class="sd">            logger_name: Name of the logger to use. Empty string for root logger.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="p">:</span> <span class="n">LovenseBLED</span> <span class="o">=</span> <span class="n">toy</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">toy</span><span class="p">,</span> <span class="n">toy_id</span><span class="p">,</span> <span class="n">logger_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the names of intensity1 and intensity2 for Lovense toys.</span>
<span class="sd">        The second value is None if the toy does not have a secondary capability</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intensity1_name</span> <span class="o">=</span> <span class="n">LOVENSE_TOY_NAMES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span><span class="p">]</span><span class="o">.</span><span class="n">intensity1_name</span>
        <span class="n">intensity2_name</span> <span class="o">=</span> <span class="n">LOVENSE_TOY_NAMES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span><span class="p">]</span><span class="o">.</span><span class="n">intensity2_name</span>
        <span class="k">return</span> <span class="n">intensity1_name</span><span class="p">,</span> <span class="n">intensity2_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity_max_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the maximum intensity value for Lovense toys. For Lovense toys the value is always 20&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">20</span>

<div class="viewcode-block" id="LovenseController.intensity1">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController.intensity1">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity1</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the intensity of the toy&#39;s primary capability to the specified level.</span>
<span class="sd">        Values outside the valid range (0-20) are clamped. Does not work if the toy is currently blocked.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            level: level to set the toy&#39;s primary intensity to.</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_paused</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># avoid the pattern overriding the command</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">intensity1</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_command</span><span class="p">(</span><span class="n">_execute</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="LovenseController.intensity2">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController.intensity2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">intensity2</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the intensity of the toy&#39;s secondary capability to the specified level.</span>
<span class="sd">        Does not work if the toy is currently blocked.</span>
<span class="sd">        Always succeeds (but does nothing) if the toy has no secondary intensity.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            level: level to set the toy&#39;s secondary intensity to.</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_blocked</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_paused</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># avoid the pattern overriding the command</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">intensity2</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_command</span><span class="p">(</span><span class="n">_execute</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="LovenseController.stop">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops all toy actions (set all intensities to zero).</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pattern</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_paused</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_command</span><span class="p">(</span><span class="n">_execute</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="LovenseController.change_rotate_direction">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController.change_rotate_direction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_rotate_direction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the rotation direction of the toy (if available, else does nothing and returns True)</span>
<span class="sd">        See self.change_rotate_direction_available() to find out if the toy supports this.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Optional callback called with True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">rotate_change_direction</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_command</span><span class="p">(</span><span class="n">_execute</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="LovenseController.get_battery_level">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController.get_battery_level">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_battery_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the battery level of the toy.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Callback called with the battery level (or None if unavailable)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">get_battery_level</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_command</span><span class="p">(</span><span class="n">_execute</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="LovenseController.get_information">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController.get_information">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gathers information about the toy. Needs to send several commands to the Toy to find out the information.</span>
<span class="sd">        Does not send commands directly but schedules them to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Callback called with a dictionary containing information about the toy.</span>
<span class="sd">                Contains the keys: &#39;Battery Level&#39;, &#39;Status&#39;, &#39;Batch number&#39;, &#39;Bluetooth name&#39;, and &#39;Device type&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute</span><span class="p">():</span>
            <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">battery</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">get_battery_level</span><span class="p">()</span>
            <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">get_batch_number</span><span class="p">()</span>
            <span class="n">device_type</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">get_device_type</span><span class="p">()</span>
            <span class="n">bluetooth_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">name</span>

            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Battery level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">battery</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">if</span> <span class="n">battery</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Unknown&quot;</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;Batch number&quot;</span><span class="p">,</span> <span class="n">batch</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;Bluetooth Name&quot;</span><span class="p">,</span> <span class="n">bluetooth_name</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;Device type&quot;</span><span class="p">,</span> <span class="n">device_type</span><span class="p">),</span>
            <span class="p">]:</span>
                <span class="n">info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Unknown&quot;</span>
            <span class="k">return</span> <span class="n">info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_command</span><span class="p">(</span><span class="n">_execute</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="LovenseController.direct_command">
<a class="viewcode-back" href="../../tikal.html#tikal.toy_controller.LovenseController.direct_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">direct_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the specified command to the toy.</span>
<span class="sd">        Does not send the command directly but schedules it to be sent by the ToyHub.</span>
<span class="sd">        The ToyHub processes new commands every 50ms so this does not introduce a noticeable delay.</span>
<span class="sd">        If the Toy is unconnected, the command is not lost but processed upon the re-establishment of connection</span>

<span class="sd">        Args:</span>
<span class="sd">            command: String containing the command to send.</span>
<span class="sd">            callback: Callback called with the response from the toy (always a string).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute</span><span class="p">():</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toy</span><span class="o">.</span><span class="n">direct_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_command</span><span class="p">(</span><span class="n">_execute</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, SnugglyBound.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>